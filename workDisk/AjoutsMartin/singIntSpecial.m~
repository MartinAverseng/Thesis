function [I] = singIntSpecial(A,B,C,X,F,dFX,N)
% Calcule l'iintégrale sur le triangle ABC de la fonction Y-> 1/norm(F(Y) - F(X))
% où norm est la norme euclidienne, F : R^2 -> R^2 est une certaine
% fonction et dFX est la différentielle de F en X (une matrice 2x2)

% On écrit 1/|F(X) - F(Y)| = 1/|F'(X).(X - Y)| + G(Y)
% où G est plus régulière.

X1 = X(1); X2 = X(2);
FX = F(X1,X2);
FX1 = FX(1); FX2 = FX(2);

fsing = @(y1,y2)(1./normFX_Y(y1,y2));

% % DEBUG
figure
plotFunOnTri(A,B,C,fsing);
figure
plotFunOnTri(A,B,C,@(x,y)(G(x,y)));

Ap = dFX*A(:);
Bp = dFX*B(:);
Cp = dFX*C(:);
Xp = dFX*X(:);

intfsingExplicit = abs(1./det(dFX))*exactIntRm1Tri(Ap,Bp,Cp,Xp);
freg = @(y1,y2)(G(y1,y2));
intGapprox =  integral2tri(freg,A,B,C);
I = intfsingExplicit + intGapprox;

    function[out] = G(y1,y2)
        Y = [y1 y2];
        
        if isequal(X,Y)
            out = G(y1+1e-8,y2+1e-8);
        else
            out = fsing(y1,y2) - 1./normdFXX_Y(y1,y2);
        end
    end

    function[out] = normFX_Y(y1,y2)
        FY = F(y1,y2); FY1 = FY(:,1); FY2 = FY(:,2);
        F1X_Y = FY1 - FX1; F2X_Y = FY2 - FX2;
        out = sqrt(F1X_Y.^2 + F2X_Y.^2);
    end
    function[out] = normdFXX_Y(y1,y2)
        N1 = size(y1,1); N2 = size(y1,2);
        y1 = y1(:);
        y2 = y2(:);
        X_Y1 = y1 - X1; X_Y2 = y2 - X2;
        
        dFXX_Y = ([X_Y1 X_Y2])*dFX;
        dF1XX_Y = dFXX_Y(:,1); dF2XX_Y = dFXX_Y(:,2);
        out = sqrt(dF1XX_Y.^2 + dF2XX_Y.^2);
        out = reshape(out',N2,N1)';
        
    end
end

